from pymongo.mongo_client import MongoClient
from pymongo import UpdateOne
from tqdm import tqdm

MONGO_URI = "mongodb+srv://..."   # <-- your URI
DB_NAME = "ProjectMaster"
COLLECTION_NAME = "Texts"

client = MongoClient(MONGO_URI)
db = client[DB_NAME]
col = db[COLLECTION_NAME]

# --- 1. Map URL substrings to newspaper names ---
PAPER_PATTERNS = {
    "dailymail.co.uk": "Daily Mail",
    "standard.co.uk": "Evening Standard",
    "theguardian.com": "The Guardian",
    # add more here if needed:
    # "thetimes.co.uk": "The Times",
    # "telegraph.co.uk": "The Telegraph",
    # ...
}

def get_paper_from_url(url: str) -> str:
    if not isinstance(url, str):
        return "Unknown"

    for pattern, name in PAPER_PATTERNS.items():
        if pattern in url:
            return name
    return "Unknown"


def main():
    BATCH_SIZE = 100

    # Only docs that don't have 'paper' yet
    query = {"paper": {"$exists": False}}

    cursor = col.find(query)
    batch_ops = []
    processed = 0

    for doc in tqdm(cursor):
        url = doc.get("_id")
        paper = get_paper_from_url(url)

        update = UpdateOne(
            {"_id": doc["_id"]},
            {"$set": {"paper": paper}}
        )
        batch_ops.append(update)
        processed += 1

        if len(batch_ops) >= BATCH_SIZE:
            col.bulk_write(batch_ops)
            batch_ops = []

    if batch_ops:
        col.bulk_write(batch_ops)

    cursor.close()
    print(f"Done. 'paper' field added/updated for ~{processed} docs.")


if __name__ == "__main__":
    main()
